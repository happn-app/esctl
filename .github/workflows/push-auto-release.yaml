name: Auto Releases

on:
  push:
    branches:
      - master
    paths:
      - .github/workflows/push-auto-release.yaml
      - pyproject.toml
  workflow_dispatch: {}

permissions:
  contents: write
  packages: write
  attestations: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.check.outputs.version }}
      skip: ${{ steps.check.outputs.skip }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-tags: true
          fetch-depth: 0

      - name: üèó Set up yq
        uses: frenck/action-setup-yq@v1.0.2
      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v7.1.2
        with:
          enable-cache: true

      - name: Check pyproject.toml version is higher than latest git tag
        id: check
        shell: bash
        run: |
          # Shamelessly copied from
          # https://stackoverflow.com/questions/4023830/how-to-compare-two-strings-in-dot-separated-version-format-in-bash
          # Adapted to echo the result, and not return it as exit code (cause it breaks the step)
          vercomp () {
              if [[ $1 == $2 ]]
              then
                  echo "0"
                  return 0
              fi
              local IFS=.
              local i ver1=($1) ver2=($2)
              # fill empty fields in ver1 with zeros
              for ((i=${#ver1[@]}; i<${#ver2[@]}; i++))
              do
                  ver1[i]=0
              done
              for ((i=0; i<${#ver1[@]}; i++))
              do
                  if ((10#${ver1[i]:=0} > 10#${ver2[i]:=0}))
                  then
                      echo ">"
                      return 0
                  fi
                  if ((10#${ver1[i]} < 10#${ver2[i]}))
                  then
                      echo "<"
                      return 0
                  fi
              done
              return 0
          }
          version=$(yq -r '.project.version' pyproject.toml)
          latest_tag=$(git describe --tags $(git rev-list --tags --max-count=1) | cut -c2-)
          changes=$(git log v$latest_tag..HEAD --pretty=format:'- %s (%an)' | sed 's/-/  -/' | sed 's|\n|\n\n|g')
          echo "Current version: $version"
          echo "Latest tag: $latest_tag"
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "latest_tag=$latest_tag" >> $GITHUB_OUTPUT
          echo 'changes<<EOF' >> $GITHUB_OUTPUT
          echo $changes >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT
          echo "Checking if $version > $latest_tag"
          if [[ $(vercomp $version $latest_tag) == '>' ]]; then
            echo "New version to release"
            echo "skip=0" >> $GITHUB_OUTPUT
          else
            echo "No new version to release"
            echo "skip=1" >> $GITHUB_OUTPUT
          fi
          exit 0

      - name: Run uv build
        if: steps.check.outputs.skip == '0'
        run: |
          uv build
          cp dist/esctl-*.tar.gz dist/esctl-latest.tar.gz
          cp dist/esctl-*.whl dist/esctl-latest.whl

      - name: Create new GitHub Release
        if: steps.check.outputs.skip == '0'
        uses: ncipollo/release-action@v1.20.0
        with:
          tag: v${{ steps.check.outputs.version }}
          name: v${{ steps.check.outputs.version }}
          commit: ${{ github.sha }}
          body: |
            ## Changes since ${{ steps.check.outputs.latest_tag }}
            ${{ steps.check.outputs.latest_tag }}...${{ steps.check.outputs.version }}
            ${{ steps.check.outputs.changes }}
          draft: false
          prerelease: false
          artifacts: dist/*

  docker:
    runs-on: ubuntu-latest
    needs: release
    if: needs.release.outputs.skip == '0'
    strategy:
      matrix:
        python-version: [ "3.11", "3.12", "3.13", "3.14" ]
        info:
          - dockerfile: Dockerfile.alpine
            flavor: alpine
          - dockerfile: Dockerfile.debian
            flavor: bookworm
          - dockerfile: Dockerfile.debian
            flavor: trixie
          - dockerfile: Dockerfile.debian
            flavor: bookworm-slim
          - dockerfile: Dockerfile.debian
            flavor: trixie-slim

    steps:
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v5

      - name: üêô Log in to GitHub Container Registry
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3.7.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.11.1

      - name: üì¶ Add docker metadata
        uses: docker/metadata-action@v5.8.0
        id: meta
        with:
          images: |
            ghcr.io/happn-app/esctl
          flavor: |
            latest=auto
            suffix=-${{ matrix.info.flavor }}
          tags: |
            type=semver,pattern={{raw}}-py${{ matrix.python-version }},value=${{ needs.release.outputs.version }}
          labels: |
            org.opencontainers.image.source="https://github.com/happn-app/esctl"
            org.opencontainers.image.description="esctl is a CLI tool to manage Elasticsearch clusters on any infrastructure."
            org.opencontainers.image.licenses="Apache-2.0"
            org.opencontainers.image.authors="Happn <ops@happn.fr>"
            org.opencontainers.image.vendor="Happn"
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: üê≥ Build and push Docker image
        uses: docker/build-push-action@v6.18.0
        with:
          context: .
          file: ./${{ matrix.info.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: true
          annotations: ${{ steps.meta.outputs.annotations }}
          tags: ghcr.io/happn-app/esctl:${{ needs.release.outputs.version }}-py${{ matrix.python-version }}-${{ matrix.info.suffix }}
          build-args: |
            OS_VERSION=${{ matrix.info.os_version }}
            GIT_REV=${{ github.sha }}
            CREATED_AT=${{ github.event.head_commit.timestamp }}
            PYTHON_VERSION=${{ matrix.python-version }}
